---
title: "Preliminary Draft: Defining and Providing Fewer Economic Resources"
output:
  html_document:
    df_print: paged
---

## Problem statement 

The Colorado State Forest Service (CSFS) encourages wildfire mitigation through the Forest Restoration & Wildfire Risk Mitigation (FRWRM) Grant Program.  The legislation authorizing funding for the program seeks to encourage funding to areas with “fewer economic resources”.  The CSFS needs to define “fewer economic resources”, and provide this information to applicants, preferably through the existing Colorado Forest Atlas.  

## Methods

The objective of this project is to construct a measure of *fewer economic resources* for the WUI in Colorado.  The layer created is intended to highlight areas that are eligible for a reduced match via the Colorado State Forest service grants for wildfire risk mitigation.

```{r,echo=FALSE,include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,fig.width=12, fig.height=8)
library(dplyr)
library(leaflet)
library(purrr)
library(sf)
library(mapview)
library(raster)
library(geojsonio)
library(stars)
#load('./Build/Index/SVI.RData')
#load('./Build/Index/SVI_comp.RData')
#SVI_comp<-SVI_comp%>%
#  dplyr::select(census_block_group,qualify_wui,flip,overall_rank_wui,qualify_state)
#load('./Build/Index/SVI_comp_crowd.RData')
#SVI_comp_crowd<-SVI_comp_crowd%>%
#  dplyr::select(census_block_group,qualify_no_crowd,flip_crowd)
#load('./Build/Data/state_08.rdata')
#load('./Build/Cache/WUI_1.RData')
#load('./Build/Cache/WUI_2.RData')

#delist<-function(geog){
#  geog%>%
#    rename(census_block_group=geoid)%>%
#  dplyr::left_join(.,SVI) 
#}
#SVI_layer<-st_out%>%
#  map_dfr(.,delist)%>%
#  st_transform( "+proj=longlat +datum=WGS84") %>%
#  na.omit()%>%
#  left_join(.,SVI_comp)%>%
#  left_join(.,SVI_comp_crowd)
#rm(SVI,st_out,SVI_comp,SVI_comp_crowd)
load('./Build/Cache/SVI_layer.RData')
load('./Build/Cache/WUI_1.RData')
load('./Build/Cache/WUI_2.RData')
WUI<-rbind(WUI_1,WUI_2)
rm(WUI_1,WUI_2)
pal<-colorQuantile("Reds",na.omit(SVI_layer$overall_rank))
pal_binary<-colorFactor(palette=c('purple','steelblue','red'), domain=c(-1,0,1))
plot(WUI)
```

## Introduction to Index

We adapt the Social Vulnerability Index (SVI) (Flanagan et al., 2011) to the wildland fire context in Colorado.  The SVI was created in response to Hurricane Katrina.  The SVI ranges from 0 (not vulnerable) to 100 (highly vulnerable), and acknowledges that those who are socially vulnerable are more likely to experience loss and less likely to recover.  Its original intent was to help state and federal level disaster responders identify the most affected areas post-event.  The authors also recognize its potential for use in other stages of the disaster cycle, such as recovery.

The projects funded by FRWRM fall into the mitigation and preparedness portions of the disaster cycle, but many of the post-event considerations apply to mitigation and preparedness.  The SVI addresses four main categories of vulnerability: socioeconomic status, household composition/ disability, minority status/ language, and housing/transportation.  These characteristics are important during all phases of the disaster cycle, especially mitigation.  Those with little purchasing power, high burden of care, or who experience difficulty interacting with the community for cultural or physical reasons will be less able to participate in mitigation activity.  Communities who have high overall levels of vulnerability may require additional assistance to complete migitation activities.  

Average measures within a community may obscure the variation in vulnerability within the community.  For example, a census defined geography may contain households that qualify as highly vulnerable and households that qualify as minimally vulnerable.  Average characteristics reported in this community may indicate moderate vulnerability.  We account for these heterogeneities by adding two measures to the SVI: income GINI coefficient, and an education GINI coefficient.  The GINI coefficient is commonly used to measure inequality, another measure of heterogeneity. Using the example of income, if everyone had the same income, the income GINI would equal zero.  Conversely, if one household collected all of the income in a CBG and the rest of the community received none, the income GINI would equal one.  

We calculate the augmented SVI using the methodology in the original paper.  Lower augmented SVI scores indicate lower vulnerability with 0 being the least vulnerable.  The Index is bounded between 0 and 1.  First, we percent rank the variables independently accross all CBGs in the area of interest, in this case Colorado.  Second, we add the scores together and percent rank them again.  This percent rank is the augmented SVI score.  We make a few minor changes to the original index variables to reflect modern ideas on measures of central tendency as well as data limitations. 

## Data

The orginal SVI was based on data from the 1990 Census.  Here we have updated it to more closely reflect the Colorado communities we see today.  We construct the Colorado SVI using data from the 2016 American Community Survey (5-year average).  While the original SVI was calculated at the census tract, we calculate it at the census block group level (smaller geographic unit) to better identify community demographics.  We then crop the spatial layers to the boundary of the WUI as defined by the boundaries used in the grant process.. 

All data analysis and geoprocessing is conducted in R Statistical Computing Language.  All steps are documented and the code is made available on GitHub.


### Variables

We describe the variables used to construct the index below.

#### Socioeconomic Status Variables
1.  Percent of individuals below the poverty line
2.  Percent of the Civilian labor force which is unemployed 
3.  Median household income
4.  Percent of adults over 25 without a High School Diploma

#### Household Composition/Disability
5.  Percent of people over the age of 65
6.  Percent of people under the age of 18 
7.  Percent of the poverty status determined population above 18 with a disability(The original index included those over 5, but this data is not included in the ACS)
8.  Percent of households with a male or female householder, no spouse present, with children under 18

#### Minority Status/Language
9.  Percent of the population that are of minority status (Non-white or Hispanic)
10. Percent of the population that speaks English less than "well"

#### Housing/Transportation
11. Percent of housing structures that have 10 or more units
12. Percent of housing units that are mobile homes
13. Percent of households that live in a housing unit with more people than rooms
14. Percent of households with no vehicle
15. Percent of people who live in group housing such as nursing homes

#### New Equity Variables
16. Income GINI
17. Years of schooling/ Education GINI

```{r CO Index, echo=FALSE,include=TRUE}
map<-leaflet(SVI_layer)%>%
  addTiles()%>%
  addPolygons(color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.6,fillColor = ~pal_binary(qualify_state),
     group="Augmented SVI",
   popup = paste("Rank", round(SVI_layer$overall_rank_wui,digits=2), "<br>",
                 "Percent of individuals below the poverty line",
                 round(SVI_layer$poverty_percent_below_1,digits=2),"%", "<br>",
                 "Percent of the Civilian labor force which is unemployed",
                 round(SVI_layer$civ_labor_force_unemployed_percent_2,digits=2),"%", "<br>",
                 "Median household income",
                 round(SVI_layer$median_hh_income_3,digits=2),"<br>",
                 "Percent of adults over 25 without a High School Diploma",
                 round(SVI_layer$no_hs_degree_percent_4,digits=2),"%", "<br>",
                 "Percent of people over the age of 65",
                 round(SVI_layer$over_65_percent_5,digits=2),"%", "<br>",
                 "Percent of people under the age of 18",
                 round(SVI_layer$under_18_percent_6,digits=2),"%", "<br>",
                 "Percent of the population above 18 with a disability",
                 round(SVI_layer$disabled_adult_percent_7,digits=2),"%", "<br>",
                 "Percent Single Parent HH",
                 round(SVI_layer$single_householder_percent_8,digits=2),"%", "<br>",
                 "Percent of the population that are of minority status",
                 round(SVI_layer$percent_minority_9,digits=2),"%", "<br>",
                 "Percent of the population that speak English < well",
                 round(SVI_layer$do_not_speak_english_well_percent_10,digits=2),"%", "<br>",
                 "Percent of housing structures that have 10 or more units",
                 round(SVI_layer$units_over_10_percent_11,digits=2),"%", "<br>",
                 "Percent of housing units that are mobile homes",
                 round(SVI_layer$units_mobile_percent_12,digits=2),"%", "<br>",
                 "Percent of households with more people than rooms",
                 round(SVI_layer$over_1_person_room_percent_13,digits=2),"%", "<br>",
                 "Percent of households with no vehicle",
                 round(SVI_layer$no_vehicle_percent_14,digits=2),"%", "<br>",
                 "Percent of people who live in group housing",
                 round(SVI_layer$group_quarters_percent_15,digits=2),"%", "<br>",
                 "Income GINI",round(SVI_layer$gini_income,digits=2),"<br>",
                 "Education GINI",round(SVI_layer$gini_education,digits=2)),
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>%
  addLegend(position="bottomright",
              colors=c('steelblue','red'),
            labels=c('does not qualify','does qualify'),
            values = ~qualify_state.x,
    title = "SVI",
    opacity=.6)%>%
  addLayersControl(
    overlayGroups = c("Augmented SVI"),
    options = layersControlOptions(collapsed = FALSE))%>%
      hideGroup(c("Augmented SVI"))
map
#rm(SVI_layer)
```

### Geographic exploration

When condsidering an index that will function well fro a specific issue and place there it is advantagous to adapt the general index to reflect its context.  In this project we are addressing wildfire preparedness in the WUI.  This means that urban areas and the concerns that arise from them are less important than they would be in a hurricane or a flood senario.  For this reason we have limited the scope of the comparitive analysis to only CBGs that contain WUI.  Additionally we are limiting the importance of some of the variables listed above that pertain to urban crowding. This importance ranking will be accomplished by assigning weights to the variables used above. These weights will bounded between (0,1). 

It is importnt not to try to gerrymander the weights in order to exclude certian areas from qualifying for additional assistance if they should not qualify due to their urban nature.  We have limited the extent of comparison to only CBGs that have WUI within them to reduce the affect of the urban area.  This resulted in a number of CBGs that previously did not qualify for the increased match do when urban areas are not considered.  No CBGs of interest lost status as a result of the cutting.
```{r WUI recut, echo=FALSE,include=TRUE}
leaflet()%>%
  addTiles()%>%
  addGEOJSON()
  addPolygons(data=WUI,color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0,
    group="WUI",
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))%>%
  addPolygons(data=WUI,color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.6,fillColor = ~pal_binary(qualify_wui),
     group="Augmented SVI WUI",
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))%>%
  addPolygons(data=SVI_layer,color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.6,fillColor = ~pal_binary(flip),
     group="WUI flip",
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>%
  addLegend(position="bottomright",
              colors=c('purple','steelblue','red'),
    title = "flip",
    labels = c("gained","same","lost"),
    opacity=.6)%>%
  addLegend(position="bottomright",
              colors=c('steelblue','red'),
            labels=c('does not qualify','does qualify'),
    title = "SVI",
    opacity=.6)%>%
  addLayersControl(
    overlayGroups = c("Augmented SVI WUI","WUI flip","WUI"),
    options = layersControlOptions(collapsed = FALSE))%>%
      hideGroup(c("Augmented SVI WUI","WUI flip","WUI"))
```

Currently we are expirimenting with setting some of the housing/transportation variables down.  The map below shows how setting the weight on variable 11 to 0 changes the allocations of vulnerable and not vulnerable. When we change the weights on the variables there is a 1-1 relationship between qualification flips.  The reduction in number of CBGs made it possible to have unbalanced qualification changes.  As a result of this change we saw 53 CBGs flip qualifications.  I propose that we set the wieghts for 11 to be zero.  Other potential weight reductions could includegroup housing, crowding?, 
```{r expirimental SVI, echo=FALSE,include=TRUE}
map_trial<-leaflet(SVI_layer)%>%
  addTiles()%>%
  addPolygons(color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.6,fillColor = ~pal_binary(qualify_state),
     group="Augmented SVI",
    #title="Augmented SVI",
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>%
  addLegend(position="bottomright",
              colors=c('steelblue','red'),
            labels=c('does not qualify','does qualify'),
    title = "SVI",
    opacity=.6) %>%
  addPolygons(color = "#444444",weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.6,fillColor = ~pal_binary(flip_crowd),
     group="WUI flip crowd",
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)) %>%
  addLegend(position="bottomright",
              colors=c('purple','steelblue','red'),
    title = "flip",
    labels = c("gained","same","lost"),
    opacity=.6)%>%
  addLayersControl(
    overlayGroups = c("Augmented SVI","WUI flip crowd"),
    options = layersControlOptions(collapsed = FALSE))%>%
      hideGroup(c("Augmented SVI","WUI flip crowd"))

map_trial
```


